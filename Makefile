VDIR := .
COQARGS := $(strip $(shell cat _CoqProject))

LINUX_HEADERS=-I /usr/src/linux-headers-$(shell uname -r)/include -I /usr/src/linux/include
CFLAGS = $(LINUX_HEADERS)

CLIGHTFLAGS = $(LINUX_HEADERS) -normalize -fstruct-passing
CLIGHTDIR = Clight

EBPF_FILES := ebpf_bug.c

CALLBACK := callback.c

default: coq

compile: demo.o 

$(CLIGHTDIR):
	mkdir $(CLIGHTDIR)

$(CLIGHTDIR)/demo.v: ebpf_bug.c ebpf_fix.c demo.c $(CLIGHTDIR)
	clightgen $(CLIGHTFLAGS) -o $@ demo.c

VFILES := $(CLIGHTDIR)/demo.v ebpf_proof_bug.v ebpf_proof.v common.v notation.v

CoqMakefile:
	coq_makefile $(COQARGS) -o CoqMakefile $(VFILES)

coq: CoqMakefile $(CLIGHTDIR)/demo.v 
	$(MAKE) -f CoqMakefile all

clean:
	find . -name "*.vo"    -type f -delete
	find . -name "*.vok"   -type f -delete
	find . -name "*.vos"   -type f -delete
	find . -name "*.aux"   -type f -delete
	find . -name "*.glob"  -type f -delete
	find . -name "*.cache" -type f -delete
	rm -f *.o

distclean: clean
	find $(CLIGHTDIR) -name "*.v" -type f -delete
	rm -f CoqMakefile CoqMakefile.conf .coqdeps.d
